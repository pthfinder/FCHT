
namespace = tournament

tournament.99 = {
	hidden = yes

	immediate = {
		remove_list_variable = {
			name = tournament_list
			target = scope:activity.activity_owner
		}
	}
}
# Decide the type of tournament.

tournament.01 = {


	option = { #local
		add_character_flag = holding_tournament

		capital_province = {
			spawn_activity = {
				type = local_tournament
				owner = root
			}
		}
		set_variable = {
			name = num
			value = 1
		}


		every_player = {
			limit = {
				NOT = {
					this = root
				}
				realm_to_title_distance_squared = {
					title = root.primary_title
					value <= 6000
				}
			}
			this = {
				add_to_variable_list = {
					name = tournament_list
					target = root
				}
			}
		}



		ai_chance = {
			base = 0
			modifier = {
				highest_held_title_tier >= tier_county
				add = 10
			}
			modifier = {
				yearly_character_income >= 25
				add = 10
			}
		}
	}

	option = { #regional
		add_character_flag = holding_tournament

		capital_province = {
			spawn_activity = {
				type = regional_tournament
				owner = root
			}
		}
		
		set_variable = {
			name = num
			value = 1
		}


		every_player = {
			limit = {
				NOT = {
					this = root
				}
				realm_to_title_distance_squared = {
					title = root.primary_title
					value <= 8000
				}
			}
			this = {
				add_to_variable_list = {
					name = tournament_list
					target = root
				}
			}
		}



		ai_chance = {
			base = 0
			modifier = {
				highest_held_title_tier >= tier_duchy
				add = 25
			}
			modifier = {
				yearly_character_income >= 50
				add = 10
			}
			modifier = {
				has_trait = humble
				has_trait = fickle
				has_trait = greedy
				add = 10
			}
		}

	}

	option = { #grand
		add_character_flag = holding_tournament

		capital_province = {
			spawn_activity = {
				type = grand_tournament
				owner = root
			}
		}
		set_variable = {
			name = num
			value = 1
		}

		every_player = {
			limit = {
				NOT = {
					this = root
				}
				realm_to_title_distance_squared = {
					title = root.primary_title
					value <= 12000
				}
			}
			this = {
				add_to_variable_list = {
					name = tournament_list
					target = root
				}
			}
		}


		ai_chance = {
			base = 0
			modifier = {
				highest_held_title_tier >= tier_kingdom
				add = 25
			}
			modifier = {
				yearly_character_income >= 100
				add = 10
			}
			modifier = {
				has_trait = ambitious
				has_trait = arrogant
				has_trait = gregarious
				add = 10
			}
		}
	}
}


#  Character receives invitation to join a tournament.
tournament.02 = {
	type = letter_event
	opening = {
		desc = tournament.02.opening
	}
	desc = tournament.02.desc
	sender = scope:activity.activity_owner

	trigger = {
		is_alive = yes
		is_at_war = no
		is_imprisoned = no
		is_incapable = no
		is_in_an_activity = no
		
	}
	immediate = {
		scope:activity.activity_owner = {
			save_scope_as = tournament_host
		}

		play_music_cue = "mx_cue_banquet"
	}




	option = {
		name = tournament.02.option.a
		trigger = {
			exists = scope:activity
		}
		scope:activity = {
			accept_invitation_for_character = root
		}
		scope:activity.activity_owner = {
			change_variable = {
				name = num
				add = 1
			}
		}

		every_knight = {
			limit = {
				is_knight_of = root
			}
			if = {
				limit = {
				is_ai = yes					
				ai_knight_will_join_with_liege = yes
				}
				scope:activity = {
					invite_character_to_activity = prev
					accept_invitation_for_character = prev
				}
				scope:activity.activity_owner = {
					change_variable = {
						name = num
						add = 1
					}
				}
			}
			else = {
				this = {
					trigger_event = tournament.05
				}

			}
		}

		

		
		remove_character_flag = invited_to_tournament

		ai_chance = {
			base = 50
			modifier = {
				add = 25
				has_trait = brave
				has_trait = gallant
			}
			modifier = {
				is_knight_of = scope:activity.activity_owner
				add = 1000
			}
			modifier = {
				is_vassal_or_below_of = scope:activity.activity_owner
				add = 30

			}
			modifier = {
				root.liege = scope:activity.activity_owner.liege
				add = 10
			}
		}
		
	}
	option = {
		name = tournament.02.option.b
		trigger = {
			exists = scope:activity
		}
		scope:activity = {
			decline_invitation_for_character = root
		}
		remove_character_flag = invited_to_tournament
		ai_chance = {
			base = 0
			modifier = {
				root.highest_held_title_tier > scope:activity.activity_owner.highest_held_title_tier  # Not super prestigious is it?
				add = -50
			}

			modifier = {
				NOT = {
					root.culture_group = scope:activity.activity_owner.culture_group
				}
				add = -10
			}
		}
	}
	option = {
		#fallback
		trigger = {
			NOT = {
				exists = scope:activity
			}
		}
	}
}

# Event for failed tournament, nobody showed up..
tournament.03 = {
	type = character_event
	title = "tournament failed"
	desc = tournament.03.desc
	theme = crown

	left_portrait = {
		character = scope:activity.activity_owner
		animation = sadness
	}
	immediate = {

		scope:activity = {
			activity_owner = {
				remove_character_flag = holding_tournament
			}
			every_participant = {
				remove_character_flag = invited_to_tournament
			}
	
		}


		every_player = {
			trigger_event = tournament.99
		}
	}

	option = {
		name = tournament.03.option
		stress_impact = {
			base = minor_stress_impact_gain
		}
	}
}

tournament.04 = { # Tournament is about to start, knights have arrived.
	type = character_event
	title = tournament.04.title #all the knights have arrived, throw a feast beforehand.
	desc = tournament.04.desc #triggered desc
	

	left_portrait = {
		character = scope:activity.activity_owner
		animation = happiness
	}

	immediate = {

		if = {
			limit = {
				NOT = {
					has_global_variable = jousting_era
				}
			}
			scope:activity = {
				every_participant = {
					trigger_event = {
						on_action = tournament_feast_event_selection
						days = 10
					}
					trigger_event = {
						id = tournament.0809
						days = 65
					}
					trigger_event = { # Closing Feast
					on_action = tournament_closing_selection 
					days = 70
					}
					if = {
						limit = {
							NOT = {
								has_character_flag = host_not_fighting
							}
						}
						trigger_event = {
							id = tournament.0100
							days = 30
						}
						trigger_event = {
							id = tournament.0101
							days = 31
						}
					}

				}
			}
		}


		every_player = {
			trigger_event = tournament.99
		}
	}

	option = {
		name = tournament.04.option.a
		trigger = {
			OR = {
				AND = {
					faith = {
						has_doctrine = doctrine_gender_male_dominated
					}
					is_male = yes
				}
				#In female dominated societies, only women can participate.
				AND = {
					faith = {
						has_doctrine = doctrine_gender_female_dominated
					}
					is_female = yes
				}
				#In equal gendered societies, anyone can participate.
				faith = {
					has_doctrine = doctrine_gender_equal
				}
			}
		}
		custom_tooltip = tournament.04.option.a.tt		
	}

	option = {
		name = tournament.04.option.b
		custom_tooltip = tournament.04.option.b.tt
		add_character_flag = host_not_fighting
	}
}


tournament.05 = {
	type = letter_event


	option = {
		scope:activity = {
			invite_character_to_activity = root
			accept_invitation_for_character = root
		}
		scope:activity.activity_owner = {
			change_variable = {
				name = num
				add = 1
			}
		}
	}
	option = {
	}
}


tournament.07 = { #You get drunk and kill someone



	immediate = {
		
		scope:activity = {
			every_participant = {
				limit = {
					is_ai = no
				}
				trigger_event = {
					on_action = tournament_dance_event_selection
					days = 10
				}
			}
		}

	}

	option = {

	}
}
tournament.08 = { # Befriend Feast
	title = tournament.08.title
	desc = tournament.08.desc
	theme = feast_activity

	left_portrait = {
		character = root
		animation = ecstasy
	}
	right_portrait = {
		character = scope:tournament_friend
		animation = ecstasy
	}

	trigger = {
		scope:activity = {
			any_participant = {
				is_ai = yes
				NOR = {
					has_relation_friend = root
					has_relation_best_friend = root
					has_relation_lover = root
					has_relation_soldier_friend = root
					has_relation_nemesis = root
					has_relation_rival = root
					this = root	
				}
				number_of_personality_traits_in_common = {
					target = root
					value >0
				}
			}
		}
	}

	immediate = {
		play_music_cue = "mx_cue_low_key_positive"
		scope:activity = {
			random_participant = {
				limit = {
					is_ai = yes
					NOR = {
						has_relation_friend = root
						has_relation_best_friend = root
						has_relation_lover = root
						has_relation_soldier_friend = root
						has_relation_nemesis = root
						has_relation_rival = root
						this = root		
					}
					number_of_personality_traits_in_common = {
						target = root
						value >0
					}
				}
				save_scope_as = tournament_friend
			}
		}


				trigger_event = {
					on_action = tournament_dance_event_selection
					days = 10
				}
			
		
		




	}

	option = {
		name = tournament.08.option.a
		set_relation_friend = scope:tournament_friend

		ai_chance = {
			base = 0
		}

	}
	option = { # Arrogant Nobleman refuses to be friends with a lowborn, even if they are a knight.
	name = tournament.08.option.b
		trigger = {
			AND = {
				root = {
					AND = {
						is_lowborn = no
						has_trait = arrogant
					}
				}
				scope:tournament_friend = {
					is_lowborn = yes
				}
			}

		}
		ai_chance = {
			base = 100
		}
	}
}
tournament.09 = { # Rival Feast
	title = tournament.08.title
	desc = tournament.08.desc
	theme = feast_activity

	left_portrait = {
		character = root
		animation = anger
	}
	right_portrait = {
		character = scope:tournament_rival
		animation = anger
		# triggered_animation = {
		# 	trigger = {

		# 	}

		# }
	}

	theme = feast_activity


	trigger = {
		scope:activity = {
			any_participant = {
				is_ai = yes
				NOR = {
					has_relation_friend = root
					has_relation_best_friend = root
					has_relation_lover = root
					has_relation_soldier_friend = root
					has_relation_nemesis = root
					has_relation_rival = root			
				}
				number_of_opposing_personality_traits = {
					target = root
					value >0
				}
			}
			
		}

	}

	immediate = {
		
		play_music_cue = "mx_cue_negative"
		
		scope:activity = {
			random_participant = {
				limit = {
					is_ai = yes
					NOR = {
						has_relation_friend = root
						has_relation_best_friend = root
						has_relation_lover = root
						has_relation_soldier_friend = root
						has_relation_nemesis = root
						has_relation_rival = root			
					}
					number_of_opposing_personality_traits = {
						target = root
						value >0
					}
				}
				save_scope_as = tournament_rival
			}
		}




		trigger_event = {
			on_action = tournament_dance_event_selection
			days = 10
		}
	}

	option = {

	}
}
tournament.10 = { #Regular Feast
	title = tournament.10
	desc = tournament.10
	theme = feast_activity



	immediate = {

		




		trigger_event = {
			on_action = tournament_dance_event_selection
			days = 10
		}
	}

	option = {

	}
}
tournament.11 = { # Awful Dance

	left_portrait = {
		character = root
		animation = shame
	}
	right_portrait = {
		character = scope:courtier
		animation = disapproval
	}
	theme = mental_break


	override_background = {
		event_background = sitting_room
	}

	immediate = {
		

		play_music_cue = " mx_cue_stress"

		every_courtier_or_guest	= {
			if = {
				limit = {
					root = {
						has_sexuality = heterosexual
					}
					sex_opposite_of	= root		
				}
				save_scope_as = courtier
			}
			else_if = {
				limit = {
					root = {
						has_sexuality = homosexual
					}
					sex_same_as	= root		
				}
				save_scope_as = courtier
			}
			else_if = {
				limit = {
					root = {
						OR = {
							has_sexuality = bisexual
							has_sexuality = asexual
						}
					}
				}
				save_scope_as = courtier
			}
		}

	}

	option = {

	}
}
tournament.12 = { # Inspiring Dance
	title = tournament.12.title
	desc = tournament.12.desc

	left_portrait = {
		character = root
		animation = flirtation
	}
	right_portrait = {
		character = scope:courtier
		animation = love
	}
	theme = love
	override_background = {
		event_background = sitting_room
	}
	trigger ={
		NOT = {
			has_character_flag = host_not_fighting
		}
	}


	immediate = {
		play_music_cue = "mx_cue_marriage"

		every_courtier_or_guest	= {
			if = {
				limit = {
					root = {
						has_sexuality = heterosexual
					}
					sex_opposite_of	= root		
				}
				save_scope_as = courtier
			}
			else_if = {
				limit = {
					root = {
						has_sexuality = homosexual
					}
					sex_same_as	= root		
				}
				save_scope_as = courtier
			}
			else_if = {
				limit = {
					root = {
						OR = {
							has_sexuality = bisexual
							has_sexuality = asexual
						}
					}
				}
				save_scope_as = courtier
			}
		}

	}

	option = {
		name = tournament.12.option.a

	}
}
tournament.13 = { # Regular Dance

	left_portrait = {
		character = root
		animation = happiness
	}
	right_portrait = {
		character = scope:courtier
		animation = happiness

	}

	theme = friendly


	override_background = {
		event_background = sitting_room
	}

	immediate = {

		play_music_cue = "mx_cue_banquet"

		every_courtier_or_guest	= {
			if = {
				limit = {
					root = {
						has_sexuality = heterosexual
					}
					sex_opposite_of	= root		
				}
				save_scope_as = courtier
			}
			else_if = {
				limit = {
					root = {
						has_sexuality = homosexual
					}
					sex_same_as	= root		
				}
				save_scope_as = courtier
			}
			else_if = {
				limit = {
					root = {
						OR = {
							has_sexuality = bisexual
							has_sexuality = asexual
						}
					}
				}
				save_scope_as = courtier
			}
		}

	}

	option = {

	}
}

#Kingdoms can license tournaments,making them occur more frequently, be larger in size. But perhaps makes factions occur more easily, or gives a scheme debuff.
#Kingdoms can prohibti tournaments, tournaments can still be held but at a risk to the character. It gives a stability bonus to the realm perhaps but you lose the potential prowess buffs for your knights.
#Pope can issue bulls about tournaments, which gives those who join a chance of beign excommunicated.
#Mid to late 1200s, Jousts appear.
#Behourds, Roundstables, Melees



#Types of tournament

#There was a very wide range, can classify them into tthree types
#Original mass tournament, the melee proper, fought between two teams of knights either in the open field or in the lists, the field tournament without enclosing barriers in the 12th century does not seem to have survived beyond the 13th century.
#The mass tournament, gives way in the late 14th century to the individual gjoust, whcih first appears in the late 12th century, but only reaches its most developed form with the tilt down the centre of the lists in the early 15th century.
#Practice tournament,


#Reasons for holding tournaments
#Held because the participants enjoyed them
#Held during sieges. (not good for gameplay, maybe a flavor event.
#End of campaign could be marked by jousts or tournaments.
#Knighting ceremonies
#Coronations
#Diplomatic Meetings
#Weddings
#Prizes were generally items, can abstract to gold.


#Wake up on the day of the event, town background



tournament.0100 = {
	title = "Morning Before"
	desc = ""

	override_background = {
		event_background = market_west
	}

	immediate = {
	}
	option = {

	}
}

#About to begin the melee, grassland background

tournament.0101 = {
	title = "The Tournament Begins!"
	desc = ""

	override_background = {
		event_background = farmland
	}
	immediate = {
		play_music_cue = "mx_cue_war_declared"

		if = {
			limit = {
				NOT = {
					has_character_flag = host_not_fighting
				}
			}
			set_variable = {
				name = number_of_captures
				value = 0
			}
			set_variable = {
				name = number_of_times_captured
				value = 0
			}
			set_variable = { 
				name = gold_earned
				value = 0
			}
			set_variable = {
				name = prowess_gained
				value = 0
			}
			trigger_event = tournament.0999
		}
	}
	option = {
		name = tournament.0101.option.a
		trigger = {
			NOT = {
				has_character_flag = host_not_fighting
			}
		}

	}
	option = {
		name = tournament.0101.option.b
		trigger = {
			has_character_flag = host_not_fighting
		}
	}
}

tournament.0800 = { #Encounter with another Knight. Fight
	title = ""
	desc = ""

	left_portrait = {
		character = scope:winner
		animation = personality_bold
	}
	right_portrait = {
		character = scope:loser
		animation = shame
	}

	override_background = {
		event_background = terrain_activity

	}
	trigger = {
		scope:activity = {
			any_participant = {
				is_alive = yes
				NOT = {
					has_character_flag = host_not_fighting
				}
			}
		}
	}


	immediate = {
		root = {
			change_variable = {
				name = EVENT_COUNTER
				add = 1
			}
		}
		scope:activity = {
			random_participant = {
				limit = {			
					is_alive = yes
					is_imprisoned = no
					is_incapable = no

					NOR = {
						this = root
						has_character_flag = host_not_fighting
					}

				}
				save_scope_as = opponent
			}
		}
			

		random_list = {
			0 = {
				modifier = {
					add = root.melee_chance
				}
				
				root = {
					save_scope_as = winner
				}
				scope:opponent = {
					save_scope_as = loser
				}
			}

			0 = {
				modifier = {
					add = scope:opponent.melee_chance
				}
		
				root = {
					save_scope_as = loser
				}
				scope:opponent = {
					save_scope_as = winner
				}
			}
		}


		if = {
			limit = {
				exists = scope:winner
			}
			scope:winner = {
				if = {
					limit = {
						has_variable = number_of_captures
					}
					change_variable = {
						name = number_of_captures
						add = 1
					}
				}
				else = {
					set_variable = {
						name = number_of_captures
						value = 1
					}
				}
	
				if = {
					limit = {
						has_variable = gold_earned
					}
					change_variable = { 
						name = gold_earned
						add = scope:loser.ransom_value
					}
				}
				else = {
					set_variable = {
						name = gold_earned
						value = scope:loser.ransom_value
					}
				}
			}
		}

		if = {
			limit = {
				exists = scope:loser
			}
			scope:loser = {
			
				if = {
					limit ={
						has_variable = number_of_times_captured
					}
					change_variable = {
						name = number_of_times_captured
						add = 1
					}
				}
				else = {
					set_variable = {
						name = number_of_times_captured
						value = 1
					}
				}
	
				if = {
					limit = {
						has_variable = gold_earned
					}
					change_variable = { 
						name = gold_earned
						subtract = scope:loser.ransom_value
					}
				}
				else = {
					set_variable = {
						name = gold_earned
						value = 0
					}
					change_variable = {
						name = gold_earned
						subtract = scope:loser.ransom_value
					}
				}
			}
		}



		if = {
			limit = {
				exists = scope:winner
				root = scope:winner
			}
			random_list = {
				0 = {
					modifier = {
						add = root.swordsmanship_upgrade_chance
					}
					add_character_flag = improve_fighting_skill  # Just so we can change in the option, rather than immediately.
				}
				
				50 = {

				}
			}
		}

		# Chance to increase prowess skill if you haven't already increased it twice this tournament. 

		if = {
			limit = {
				var:prowess_gained < 2
			}
			random_list = {
				0 = {
					modifier = {
						add = root.prowess_gain_chance
					}
					add_prowess_skill = 1
					change_variable = {
						name = prowess_gained
						add = 1
					}
				}
				50 = {
		
				}
			}
			
		}


		if = {
			limit = {
				var:EVENT_COUNTER <=3	
			}
		
			random_list = {
				50 = {
					modifier = {
						positive_traits_tournament_small = yes
						add = 5
					}
					modifier = {
						positive_traits_tournament_medium = yes
						add = 10
					}
					modifier = {
						positive_traits_tournament_large = yes
						add = 15
					}
					trigger_event = {
						on_action = tournament_melee_good_selection
						days = 5
					}
				}
					

				50 = {
					modifier = {
						negative_traits_tournament_small = yes
						add = 5
					}
					modifier = {
						negative_traits_tournament_medium = yes
						add = 10
					}
					modifier = {
						negative_traits_tournament_large = yes
						add = 15
					}
					if = {
						limit = {

						}
					}
					trigger_event = {
						on_action = tournament_melee_bad_selection
						days = 5
					}
				}
			}
		}
		else = {
			trigger_event = tournament.0807
		}

	}
	
	option = {
		name = tournament.0800.option
		
		if = {
			limit = {
				has_character_flag = improve_fighting_skill
			}

			if = {
				limit = {
					NOR = {
						has_trait = poor_fighter
						has_trait = trained_fighter
						has_trait = skilled_fighter
						has_trait = formidable_fighter
					}
				}
				add_trait = poor_fighter
			}
			if = {
				limit = {
					has_trait = poor_fighter
				}
				add_trait = trained_fighter
			}
			if = {
				limit = {
					has_trait = trained_fighter
				}
				add_trait = skilled_fighter
			}
			if = {
				limit = {
					has_trait = skilled_fighter
				}
				add_trait = formidable_fighter
			}
			
			



		}
	
	}

}
		

tournament.0802 = { #You and another knight team up on someone
	title = ""
	desc = ""



	override_background = {
		event_background = terrain_activity

	}

	immediate = {
		root = {
			change_variable = {
				name = EVENT_COUNTER
				add = 1
			}
		}
		random_list = {
			50 = {
				modifier = {
					positive_traits_tournament_small = yes
					add = 5
				}
				modifier = {
					positive_traits_tournament_medium = yes
					add = 10
				}
				modifier = {
					positive_traits_tournament_large = yes
					add = 15
				}
				trigger_event = {
					on_action = tournament_melee_good_selection
					days = 5
				}
			}
			

			50 = {
				modifier = {
					negative_traits_tournament_small = yes
					add = 5
				}
				modifier = {
					negative_traits_tournament_medium = yes
					add = 10
				}
				modifier = {
					negative_traits_tournament_large = yes
					add = 15
				}

				trigger_event = {
					on_action = tournament_melee_bad_selection
					days = 5
				}
			}
		}
	}
	option = {

	}
}
tournament.0803 = { #You are teamed up on
	title = ""
	desc = ""


	override_background = {
		event_background = terrain_activity

	}
	immediate = {
		root = {
			change_variable = {
				name = EVENT_COUNTER
				add = 1
			}
		}
		random_list = {
			50 = {
				modifier = {
					positive_traits_tournament_small = yes
					add = 5
				}
				modifier = {
					positive_traits_tournament_medium = yes
					add = 10
				}
				modifier = {
					positive_traits_tournament_large = yes
					add = 15
				}
				trigger_event = {
					on_action = tournament_melee_good_selection
					days = 5
				}
			}
			

			50 = {
				modifier = {
					negative_traits_tournament_small = yes
					add = 5
				}
				modifier = {
					negative_traits_tournament_medium = yes
					add = 10
				}
				modifier = {
					negative_traits_tournament_large = yes
					add = 15
				}

				trigger_event = {
					on_action = tournament_melee_bad_selection
					days = 5
				}
			}
		}
	}
	option = {
		
	}
}

tournament.0804 = { # You accidentally killed someone
	title = ""
	desc = ""


	override_background = {
		event_background = terrain_activity

	}
	immediate = {
		root = {
			change_variable = {
				name = EVENT_COUNTER
				add = 1
			}
		}

		if = {
			limit = {
				root = {
					var:EVENT_COUNTER <= 3
				}
			}
			random_list = {
				50 = {
					modifier = {
						positive_traits_tournament_small = yes
						add = 5
					}
					modifier = {
						positive_traits_tournament_medium = yes
						add = 10
					}
					modifier = {
						positive_traits_tournament_large = yes
						add = 15
					}
					trigger_event = {
						on_action = tournament_melee_good_selection
						days = 5
					}
				}
				
	
				50 = {
					modifier = {
						negative_traits_tournament_small = yes
						add = 5
					}
					modifier = {
						negative_traits_tournament_medium = yes
						add = 10
					}
					modifier = {
						negative_traits_tournament_large = yes
						add = 15
					}
	
					trigger_event = {
						on_action = tournament_melee_bad_selection
						days = 5
					}
				}
			}
		}
		else = {
			trigger_event = {
				id = tournament.0807
				days = 5
			}
		}
	}
	option = {
		
	}
}

tournament.0805 = { #You were accidently killed 
	title = ""
	desc = ""


	override_background = {
		event_background = terrain_activity

	}
	immediate = {
		root = {
			change_variable = {
				name = EVENT_COUNTER
				add = 1
			}
		}
		if = {
			limit = {
				root = {
					var:EVENT_COUNTER <= 3
				}
			}
			random_list = {
				50 = {
					modifier = {
						positive_traits_tournament_small = yes
						add = 5
					}
					modifier = {
						positive_traits_tournament_medium = yes
						add = 10
					}
					modifier = {
						positive_traits_tournament_large = yes
						add = 15
					}
					trigger_event = {
						on_action = tournament_melee_good_selection
						days = 5
					}
				}
				

				50 = {
					modifier = {
						negative_traits_tournament_small = yes
						add = 5
					}
					modifier = {
						negative_traits_tournament_medium = yes
						add = 10
					}
					modifier = {
						negative_traits_tournament_large = yes
						add = 15
					}

					trigger_event = {
						on_action = tournament_melee_bad_selection
						days = 5
					}
				}
			}
		}

		else = {
			trigger_event = {
				
				id = tournament.0807
				days = 5
			}
		}
	}
	option = {
		
	}
}


tournament.0806 = { #drainage pipe meme event
	title = ""
	desc = ""


	override_background = {
		event_background = terrain_activity

	}
	immediate = {

		root = {
			change_variable = {
				name = EVENT_COUNTER
				add = 1
			}
		}

		if = {
			limit = {
				root = {
					var:EVENT_COUNTER <= 3
				}
			}
			random_list = {
				50 = {
					modifier = {
						positive_traits_tournament_small = yes
						add = 5
					}
					modifier = {
						positive_traits_tournament_medium = yes
						add = 10
					}
					modifier = {
						positive_traits_tournament_large = yes
						add = 15
					}
					trigger_event = {
						on_action = tournament_melee_good_selection
						days = 5
					}
				}
				

				50 = {
					modifier = {
						negative_traits_tournament_small = yes
						add = 5
					}
					modifier = {
						negative_traits_tournament_medium = yes
						add = 10
					}
					modifier = {
						negative_traits_tournament_large = yes
						add = 15
					}

					trigger_event = {
						on_action = tournament_melee_bad_selection
						days = 5
					}
				}
			}
		}
		else = {
			trigger_event = {			
				id = tournament.0807
				days = 5
			}
		}
	}
	option = {
		
	}
}

tournament.0807 = {

	hidden = yes

	immediate = {

		change_variable = {
			name = EVENT_COUNTER
			add = 1
		}

		scope:activity = {
			random_participant = {
				limit = {
					
					is_alive = yes
					is_imprisoned = no
					is_incapable = no
					NOR = {
						this = root
						has_character_flag = host_not_fighting
					}
				}
				save_scope_as = opponent
			}
		}

		random_list = {
			0 = {

				modifier = {
					add = root.melee_chance
				}

			
				root = {
					save_scope_as = winner
				}
				scope:opponent = {
					save_scope_as = loser
				}
			}

			0 = {

				modifier = {
					add = scope:opponent.melee_chance
				}

				

				root = {
					save_scope_as = loser
				}
				scope:opponent = {
					save_scope_as = winner
				}
			}
		}

		scope:winner = {
			if = {
				limit = {
					has_variable = number_of_captures
				}
				change_variable = {
					name = number_of_captures
					add = 1
				}
			}
			else = {
				set_variable = {
					name = number_of_captures
					value = 1
				}
			}

			if = {
				limit = {
					has_variable = gold_earned
				}
				change_variable = { 
					name = gold_earned
					add = scope:loser.ransom_value
				}
			}
			else = {
				set_variable = {
					name = gold_earned
					value = scope:loser.ransom_value
				}
			}
		}
		scope:loser = {
			
			if = {
				limit ={
					has_variable = number_of_times_captured
				}
				change_variable = {
					name = number_of_times_captured
					add = 1
				}
			}
			else = {
				set_variable = {
					name = number_of_times_captured
					value = 1
				}
			}

			if = {
				limit = {
					has_variable = gold_earned
				}
				change_variable = { 
					name = gold_earned
					subtract = scope:loser.ransom_value
				}
			}
			else = {
				set_variable = {
					name = gold_earned
					value = 0
				}
				change_variable = {
					name = gold_earned
					subtract = scope:loser.ransom_value
				}
			}
		}

		if = {
			limit = {
				AND = {
					var:EVENT_COUNTER <10
					NOT = {
						has_character_flag = host_not_fighting
					}
				}
			}
			trigger_event = tournament.0807
		}

		else_if = {
			limit = {
				NOT = {
					has_character_flag = host_not_fighting
				}
			}
			trigger_event = {
				id = tournament.0808
				days = 5
			}
		}

	}

}



tournament.0808 = {
	title = tournament.0808.title
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					root.performance_rating = -1
				}
				desc = tournament.0808.desc.poor
			}
			triggered_desc = {
				trigger = {
					root.performance_rating = 0
				}
				desc = tournament.0808.desc.ok
			}
			triggered_desc = {
				trigger = {
					root.performance_rating = 2
				}
				desc = tournament.0808.desc.moderate
			}
			triggered_desc = { 
				trigger = {
					root.performance_rating = 5
				}
				desc = tournament.0808.desc.great
			}
		}

	}
	
	left_portrait = {
		character = root
		triggered_animation = {
			trigger = {
				root.performance_rating = -1
			}
			animation = shame
		}
		triggered_animation = {
			trigger = {
				root.performance_rating = 0
			}
			animation = disgust
		}
		triggered_animation = {
			trigger = {
				root.performance_rating = 2
			}
			animation = personality_honorable
		}
		triggered_animation = {
			trigger = {
				root.performance_rating = 5
			}
			animation = personality_bold
		}
		animation = idle
	}

	override_background = {
		event_background = corridor_night
	}

	immediate = {


		set_variable = {
			name = capture_diff
			value = var:number_of_captures
		}
		change_variable = {
			name = capture_diff
			subtract = var:number_of_times_captured
		}

	}
	option = {
		if = {
			limit = {
				var:gold_earned >= 0
			}
			add_gold = var:gold_earned
		}

		else_if = {
			limit = {
				var:gold_earned < 0
			}

			remove_short_term_gold = root.abs_value

		}
	}

}

tournament.0809 = {
	title = tournament.0809.title
	desc = tournament.0809.desc

	left_portrait = {
		character = scope:activity.activity_owner
		animation = ecstasy
	}
	# right_portrait = {
	# 	character = scope:attendee
	# 	triggered_animation = {
	# 		trigger = {
	# 			scope:attendee.performance_rating > 0
	# 		}
	# 		animation = happiness
	# 	}
	# 	animation = idle
	# }

	lower_left_portrait = scope:first_place
	lower_center_portrait = scope:second_place
	lower_right_portrait = scope:third_place

	theme = feast_activity
	override_background = {
		event_background = throne_room_scope
	}


	immediate = {
		play_music_cue = "mx_cue_meadandwine"


		scope:activity = {
			every_participant = {
				limit = {
					NOT = {
						has_character_flag = host_not_fighting
					}
					has_variable = capture_diff
				}
				add_to_list = participant_list

			}
		}

		
		root.melee_ranking = {
			save_scope_as = THE_RANK
		}

	
		ordered_in_list = {
			list = participant_list
			order_by = melee_ranking
			max = 1
			save_scope_as = first_place
			remove_from_list = participant_list
		}
		ordered_in_list = {
			list = participant_list
			order_by = melee_ranking
			max = 1
			save_scope_as = second_place
			remove_from_list = participant_list
		}

		ordered_in_list = {
			list = participant_list
			order_by = melee_ranking
			max = 1
			save_scope_as = third_place
			remove_from_list = participant_list
		}






	}

	option = { #First place
		name = tournament.0809.option.a
		trigger = {
			root = scope:first_place
		}
		add_gold = melee_prize_first
		add_prestige = melee_prestige_gain_large

	}
	option = { #Second place
		name = tournament.0809.option.b
		trigger = {
			root = scope:second_place
		}
		add_gold = melee_prize_second
		add_prestige = melee_prestige_gain_medium

	}	
	option = {#Third place
		name = tournament.0809.option.c
		trigger = {
			root = scope:third_place
		}
		add_gold = melee_prize_third
		add_prestige = melee_prestige_gain_small
	}
	option = { #Host
		name = tournament.0809.option.d
		trigger = {
			root = scope:activity.activity_owner
			NOR = {
				root = scope:first_place
				root = scope:second_place
				root = scope:third_place
			}
		}
		
	}
	option = {#Everyone else
		name = tournament.0809.option.d
		trigger = {
			NOR = {
				root = scope:activity.activity_owner
				root = scope:first_place
				root = scope:second_place
				root = scope:third_place
			}
		}

	}
}





tournament.0810 = {
	title = tourmament.0810
	left_portrait = root

	trigger = {
		exists = scope:activity
	}

	immediate = {

		remove_variable = prowess_gained
		remove_variable = gold_earned
		remove_variable = number_of_captures
		remove_variable = number_of_times_captured
		remove_variable = capture_diff
		remove_variable = EVENT_COUNTER
		if = {
			limit = {
				root = scope:activity.activity_owner
			}
			remove_variable = num
			if = {
				limit = {
					has_character_flag = host_not_fighting
				}
				remove_character_flag = host_not_fighting
			}
		}
	}

	option = {
		if = {
			limit = {
				root = scope:activity.activity_owner
			}
			add_prestige = tournament_host_prestige
		}
		scope:activity = {
			complete_activity = yes
		}
	}
}















tournament.0999 = {
	hidden = yes

	trigger = {
		NOT = {
			has_character_flag = host_not_fighting
		}
	}

	immediate = {

		root = {
			set_variable = {
				name = EVENT_COUNTER		
				value = 0
			}
		}


				random_list = {
					50 = {
						modifier = {
							positive_traits_tournament_small = yes
							add = 5
						}
						modifier = {
							positive_traits_tournament_medium = yes
							add = 10
						}
						modifier = {
							positive_traits_tournament_large = yes
							add = 15
						}
						trigger_event = {
							on_action = tournament_melee_good_selection
							days = 5
						}
					}
					

					50 = {
						modifier = {
							negative_traits_tournament_small = yes
							add = 5
						}
						modifier = {
							negative_traits_tournament_medium = yes
							add = 10
						}
						modifier = {
							negative_traits_tournament_large = yes
							add = 15
						}

						trigger_event = {
							on_action = tournament_melee_bad_selection
							days = 5
						}
					}
				}
			
		
	}
}





